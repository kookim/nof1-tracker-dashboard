# 最近30天改造方案（仅交易相关统计）

目的：将交易相关统计（例如“最大盈利/最大损失”“最近交易列表的数据来源”）统一按“最近30天”的时间窗口统计；账户总盈利/总盈利率继续使用初始资金 `initialAssetValue` 口径，不按30天滚动。

## 范围与不做的事项

- 变更范围：
  - 交易获取：按时间窗口获取最近30天交易，必要时分页拼接。
  - 交易统计：基于最近30天的交易计算“最大盈利/最大损失”等。
  - UI 文案：与交易有关的统计标注“最近30天”。
- 不变更：
  - 账户总盈利/总盈利率计算口径仍为：`totalWalletBalance - initialAssetValue`。
  - 现有环境变量、部署流程不调整。

## 技术方案

### 1) 前端：按时间窗口获取交易（最近30天）

- 动态时间窗口：
  - `startTime = now - 30天`
  - `endTime = now`
- 接口调用：沿用现有 `/api/trades`，新增传入 `startTime`、`endTime`（毫秒时间戳）。后端会透传到币安接口（后端无需改动）。
- 分页策略（防止数据量大或单次 limit 限制）：
  - 使用 `limit = 1000` 起步，若失败或数据不足，降级为 `500 -> 250 -> 100`（已有降级框架，可复用）。
  - 如需更稳健，可追加使用 `fromId` 继续拉取剩余数据，直至命中 `startTime` 为止或达到最大迭代次数（防止无限循环）。
- 失败兜底：
  - 若时间窗口获取失败，继续展示核心数据（账户/仓位/最近25笔交易），并将“最大盈利/最大损失”基于当前已获取的最近25笔计算（已有降级逻辑）。

落地点：修改 `public/script.js`
- 新增工具函数：`getThirtyDaysWindow()` 返回 `{ startTime, endTime }`。
- 改造 `getAllTrades()`：优先携带 `startTime/endTime` 拉取；维持多 limit 降级；必要时分页拼接。

### 2) 前端：统计仅使用最近30天交易

- 现有 `calculateMaxProfitLoss()` 中按 `baseDate` 过滤交易：
  - 将 `baseDate` 替换为动态 `now - 30天`（不再依赖配置文件里的固定日期）。
  - 过滤逻辑不变：仅保留 `trade.time >= startTime` 的交易。
- “最近交易记录”区块本身展示最近若干笔（默认25），无需修改；但其统计与“最大盈利/损失”的说明需标注“最近30天”。

### 3) UI 文案与显示

- 顶部总资产/总盈利/总盈利率：不变（基于 `initialAssetValue`）。
- 与交易相关的统计：
  - 标注“最近30天”。
  - 若 30 天内无交易，显示“最近30天内暂无交易数据”。

### 4) 后端（Cloudflare Worker）

- 现有实现 `handleBinanceRequest(path, queryParams, env)` 会透传 `queryParams` 到币安，已满足 `startTime/endTime` 需求，无需改动。
- 时间戳同步逻辑已加入（对齐币安服务器时间），保持现状。

## 验收标准（Acceptance Criteria）

- 时间窗口：交易类统计只使用最近30天的交易数据；可通过修改系统时间或构造数据验证。
- 稳定性：当单次拉取失败/受限时，会自动降级/分页，不影响整体页面更新（不会再出现“间歇性失败导致右上角错误”）。
- 回退逻辑：
  - 30天内无交易时，页面展示无数据提示，但不报错；
  - 账户盈亏仍显示基于 `initialAssetValue` 的口径，且数值与改造前一致。

## 实施步骤（建议顺序）

1. 新增 `getThirtyDaysWindow()` 并改造 `getAllTrades()` 按窗口+分页拉取。
2. 将 `calculateMaxProfitLoss()` 里的时间过滤改为使用动态 30 天窗口。
3. 更新与交易相关的 UI 文案（“最近30天”）。
4. 联调与测试：
   - 正常账户（30天内有交易）
   - 30天内无交易
   - 高频账户（需要分页）
   - API 降级/受限场景（观察不再中断主流程）

## 风险与缓解

- 币安接口限流：分页时控制迭代次数与间隔；保持已有降级兜底。
- 数据量较大：限制最大分页轮数或总条目上限（例如最多请求 N 页）。
- 时区/时间戳：`startTime/endTime` 统一使用毫秒 UTC 时间戳；页面展示使用本地化格式。

## 兼容性说明

- 配置文件 `public/trading-config.js` 仍保留 `initialAssetValue`，但不再需要固定 `baseDate` 来驱动交易过滤；若保留显示，可在 UI 文案上改为“最近30天”。
- 部署与环境变量不受影响。

---

如需开启“最近X天”的可配置化，只需将 30 天常量提取为配置项（默认30），并在 `getThirtyDaysWindow()` 中读取该值。


